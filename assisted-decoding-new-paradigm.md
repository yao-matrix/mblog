# è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆ - æ–‡æœ¬ç”Ÿæˆæ–°èŒƒå¼

## å¼•è¨€
LLM è¦è·¨è¶Šä»æ—©æœŸé‡‡ç”¨è€…åˆ°å¤§ä¼—å¸‚åœºçš„é¸¿æ²Ÿï¼Œå…¶å¿…è¦æ¡ä»¶æ˜¯ä»·æ ¼å¤§ä¼—åŒ–ï¼Œä¹Ÿå°±æ˜¯é™ä½æ¯è¯å…ƒçš„ä»·æ ¼ã€‚

![cross the chasm|center](assets/assisted-decoding-new-paradigm/image-0.png)

è¿™ç§é™ä½æœ€å¥½æ˜¯â€œå…è´¹â€çš„é™ä½ï¼Œè€Œä¸æ˜¯â€œè®¨ä»·è¿˜ä»·â€çš„é™ä½ã€‚æ‹¿ç”µä»·æ‰“æ¯”æ–¹ï¼Œè¿™ç§é™ä½æœ€å¥½æ˜¯ç›´æ¥çš„ç”µè´¹é™ä½ï¼Œè€Œä¸æ˜¯ä½¿ç”¨â€œçœç”µå°å¦™æ‹›â€å¸¦æ¥çš„é™ä½ï¼Œè¿™æ ·æ‰èƒ½çœŸæ­£åšåˆ°å¤§ä¼—åŒ–ã€‚åœ¨è¿™ç§è¯­å¢ƒä¸‹ï¼Œprompt å‹ç¼©ã€æ¨¡å‹é‡åŒ–è¿™ç±»ä¼˜åŒ–å°±æ˜¯â€œè®¨ä»·è¿˜ä»·â€å‹ä¼˜åŒ–ï¼Œå®ƒä»¬è¦ä¹ˆéœ€è¦ç”¨æˆ·å…·å¤‡æŸäº›ä¸“å®¶æ€§çš„çŸ¥è¯†ã€è¦ä¹ˆéœ€è¦ç”¨æˆ·æ”¾å¼ƒä¸€äº›ç”Ÿæˆè´¨é‡çš„ä¸€è‡´æ€§è¦æ±‚ï¼Œæ€»ä¹‹æ˜¯éœ€è¦ç”¨æˆ·ä»˜å‡ºä¸€äº›æˆæœ¬ã€‚

> **æ¨¡å‹é‡åŒ–ä¸æ˜¯â€œå…è´¹â€çš„é™ä»·**
> 
> ä»¥ `BLOOM-176B` ä¸ºä¾‹ï¼Œå¯¹æç¤º _Once upon a time, there existed a little girl, who liked to have adventures. She wanted to go to places and meet new people and have fun._
> 
> åŸå§‹ BF16 æ¨¡å‹çš„ç”Ÿæˆä¸ºï¼š_She wanted to see the world, and she wanted to be a part of it. She wanted to make a difference, and she wanted to make the world_
> 
> ç›´æ¥é‡åŒ–åçš„ INT8 æ¨¡å‹ç”Ÿæˆä¸ºï¼š_She wanted to learn new things. She wanted to do things she had never done before. She wanted to do things she had never done before. She wanted to_
> 
> INT8 é‡åŒ–æ¨¡å‹ç»“å·´äº†ï¼

è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆå¸¦æ¥äº†è¿™ç§å¯èƒ½æ€§ï¼Œä¸éœ€è¦â€œå¤´ç§ƒâ€å»åš prompt å‹ç¼©ï¼Œä¹Ÿä¸éœ€è¦å°å¿ƒç¿¼ç¿¼åœ°å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ä»¥ä½¿è´¨é‡æŸå¤±æ§åˆ¶åœ¨å¯æ¥å—çš„èŒƒå›´å†…ï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸€ä¸ªâ€œèµ·è‰ + å®¡é˜…â€çš„æ–°èŒƒå¼ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ— æŸçš„æ¨¡å‹åŠ é€ŸèŒƒå¼ã€‚å…¶åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Alt text|center](assets/assisted-decoding-new-paradigm/image-1.png)

å‡è®¾è¦å¯¹ `BLOOM-176B` æ¨¡å‹è¿›è¡ŒåŠ é€Ÿï¼Œåœ¨è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆçš„èŒƒå¼ä¸­ï¼Œæˆ‘ä»¬æŠŠå®ƒå«åš `target generator`ï¼ˆè“è‰²æ¡†ï¼‰ã€‚æˆ‘ä»¬ç»™å®ƒé…ä¸€ä¸ªå°å¼Ÿï¼Œå°±å«å®ƒ `draft generator`ï¼ˆé»„è‰²æ¡†ï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è´Ÿè´£ç»™å®ƒèµ·è‰å›ç­”çš„ã€‚è¿™æ ·ï¼Œç­å­å°±æ­èµ·æ¥äº†ï¼Œå·¥ä½œæ¨¡å¼å°±å˜æˆäº†ï¼šå°å¼Ÿè´Ÿè´£èµ·è‰ï¼Œå¤§å“¥è´Ÿè´£å®¡é˜…ã€‚è¿™ç§èŒƒå¼çš„å¥½å¤„å¾ˆç›´ç™½ï¼š

- é€Ÿåº¦å¿«ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç›®å‰çš„ LLM å‡ ä¹å…¨éƒ¨éƒ½æ˜¯ `decoder-only` æ¶æ„çš„ï¼Œå…¶æœ¬è´¨æ˜¯è‡ªå›å½’æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºéœ€è¦ä¸€ä¸ªå­—ä¸€ä¸ªå­—åœ°ç”Ÿæˆï¼Œè¿™ä¹Ÿæ˜¯ LLM ç”Ÿæˆå¾ˆéš¾åŠ é€Ÿçš„æœ¬è´¨åŸå› ï¼Œå› ä¸ºæœ‰ `step-wise dependency`ã€‚è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆå°† `step-wise dependency` ä¹¾å¤å¤§æŒªç§»ç»™äº†å¼€é”€å°çš„ `draft model`ï¼Œè€Œ `target model` åªéœ€è¦è´Ÿè´£éªŒè¯çš„éƒ¨åˆ†ï¼Œè€ŒéªŒè¯æ˜¯ä¸€ä¸ªå…¸å‹çš„ `CLM(Causal Language Modeling)` å·¥ä½œè´Ÿè½½ï¼Œä¸€æŠŠå¤´å°±å¯ä»¥å…¨éƒ¨éªŒè¯å®Œã€‚ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼šç”¨ `LLaMA-2-13B` åœ¨ `A100 GPU` ä¸Šç”Ÿæˆ `128` ä¸ªè¯å…ƒçš„æ—¶é—´æ‰€èŠ±çš„æ—¶é—´æ˜¯å¯¹åŒæ ·é•¿åº¦çš„åºåˆ—åš `CLM` å‰å‘æ‰€èŠ±æ—¶é—´çš„çº¦ `100` å€ $^{[1]}$ã€‚å› æ­¤å¯ä»¥æƒ³è§ï¼Œ`step-wise dependency` çš„è½¬ç§»ï¼Œé‡Šæ”¾äº†é€Ÿåº¦çš„æ½œèƒ½ã€‚

- ç”Ÿæˆä¸€è‡´ã€‚å› ä¸ºæœ€ç»ˆè¾“å‡ºç»“æœæ˜¯ç”± `target model` å®¡å®šçš„ï¼Œåœ¨ä½¿ç”¨â€œç²¾ç¡®åŒ¹é…â€çš„å®¡å®šç­–ç•¥æ—¶ï¼Œå¯ä»¥åšåˆ°è¾“å‡ºä¸€è‡´ï¼Œæ— éœ€ç”Ÿæˆè´¨é‡çš„ä»»ä½•æŠ˜è¡·ã€‚

å®Œç¾åˆ‡ä¸­æˆ‘ä»¬çš„è¯‰æ±‚ã€‚

æˆ‘ä»¬ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬è¿‡ä¸€éè¾…åŠ©å¼ç”ŸæˆèŒƒå¼çš„å·¥ä½œæµç¨‹ï¼š

- ç¬¬ä¸€æ­¥ï¼šç”± `draft model` ä¸ºæç¤º `"The orange cat"` ç”Ÿæˆ `K` ä¸ªè¡¥å…¨è¯ã€‚æœ¬ä¾‹ä¸­, `K` ä¸º 3ï¼Œ`draft model` ç”Ÿæˆäº† 3 ä¸ªè¡¥å…¨è¯ `ate the fish`ã€‚

- ç¬¬äºŒæ­¥ï¼šå°† `The orange cat ate the fish` é€ç»™ `target model` æ‰§è¡Œå‰å‘ logit è®¡ç®—ã€‚`target model` ç®—å¾—ç¬¬ 2 ä¸ªè¡¥å…¨è¯ `the` çš„ logit å¹¶éæœ€å¤§ï¼Œè€Œæ˜¯ `my` æœ€å¤§ï¼Œå› æ­¤æ‹’ç»äº† `draft model` ç”Ÿæˆçš„ç¬¬ 2 ä¸ªè¯åŠå…¶ä¹‹åçš„è¯ï¼Œä¹Ÿå³å…¶æ¥å—äº† $\frac{1}{3}$ çš„è¡¥å…¨è¯ï¼Œæœ€ç»ˆæœ¬è½®çš„è¾“å‡ºè¡¥å…¨è¯ä¸º `ate my`ï¼Œè¯æ•°ä¸º 2ã€‚

- ç¬¬ä¸‰æ­¥ï¼šç¡®å®šæ˜¯å¦æ»¡è¶³ç»“æŸæ¡ä»¶ï¼Œå¦‚æ»¡è¶³ç»“æŸç”Ÿæˆï¼›å¦‚ä¸æ»¡è¶³ï¼Œæç¤ºå˜æˆ `"The orange cat ate my"` è¿”å›ç¬¬ä¸€æ­¥ï¼Œç»§ç»­ç”Ÿæˆã€‚

åœ¨ä¸Šè¿°æµç¨‹ä¸­ï¼š`K` ä¸ºè‰ç¨¿çª—å£ï¼Œå³æ¯æ¬¡æ‰“è‰ç¨¿ç”Ÿæˆå¤šå°‘ä¸ªè¯ï¼Œä¹Ÿå« `look ahead window`ï¼›$\frac{1}{3}$ ä¸ºæ¥å—ç‡ï¼Œæˆ‘ä»¬ç”¨ $\alpha$ è¡¨ç¤ºï¼›æœ€ç»ˆç» `target model` å®¡å®šåè¾“å‡ºçš„è¯æ•°ä¸º $\alpha K+1$ï¼Œæˆ‘ä»¬å«å®ƒ`å‹ç¼©ç‡ï¼ˆcompression ratioï¼‰`ã€‚

ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªè¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆçš„ç»éªŒåŠ é€Ÿå…¬å¼ï¼š
$acc\_ratio=\frac{l_t \times (\alpha K+1)}{Kl_d + l_t}=\frac{\alpha K+1}{K\frac{l_d}{l_t}+1}$
å…¶ä¸­ $l_d$ ä¸º `draft model` çš„æ¯è¯å…ƒå»¶è¿Ÿï¼Œ$l_t$ ä¸º `target model` çš„æ¯è¯å…ƒå»¶è¿Ÿã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæƒ³è¦è·å¾—å¥½çš„åŠ é€Ÿéœ€è¦æé«˜æ¥å—ç‡ $\alpha$ã€é™ä½ $\frac{l_d}{l_t}$ï¼Œè¿™ä¸¤è€…æœ‰æ—¶æ˜¯æ­£ç›¸å…³çš„ï¼Œå› æ­¤éœ€è¦æŠ˜è¡·ã€‚

> **What-If åˆ†æ**
> - è®¾ K=4ï¼Œğ›¼=0.75, å¦‚éœ€è·å¾— 2 å€åŠ é€Ÿï¼Œéœ€æœ‰ $\frac{l_d}{l_t} \le \frac{1}{4}$;
> - è®¾ K=4ï¼Œğ›¼=0.5, å¦‚éœ€è·å¾— 2 å€åŠ é€Ÿï¼Œéœ€æœ‰ $\frac{l_d}{l_t} \le \frac{1}{8}$;

æ³¨æ„è¿™é‡Œ `K` å¯ä»¥ä¸æ˜¯å›ºå®šå€¼ï¼Œè€Œæ˜¯æ ¹æ® $\alpha$ è”åŠ¨çš„åŠ¨æ€å€¼ï¼›å®¡å®šç­–ç•¥ä¹Ÿæœªå¿…ä¸€å®šæ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä¹Ÿå¯ä»¥æ˜¯è½¯åŒ¹é…ã€‚ä½†è¿™äº›æˆ˜æœ¯ä¸Šçš„å¾®è°ƒï¼Œéƒ½ä¸å½±å“èŒƒå¼å±‚é¢çš„å¤§ç»“è®ºã€‚

èŒƒå¼ç¡®ç«‹ä»¥åï¼Œä¸‹é¢å°±æ˜¯çœ‹åŸºäºè¿™ä¸ªèŒƒå¼æœ‰å“ªäº›æ–¹æ³•äº†ã€‚

## ç°æœ‰æ–¹æ³•

### vanilla

æœ€ç›´è§‚çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå°æ¨¡å‹ï¼ˆSLMï¼ŒSmall Language Modelï¼‰ä¸º LLM æ‰“è‰ç¨¿äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¯¥æ–¹æ³•ä¹Ÿæ˜¯ `Hugging Face transformers` é»˜è®¤çš„æ–¹æ³•ã€‚

![Alt text|center](assets/assisted-decoding-new-paradigm/image-2.png)

æˆ‘ä»¬åšä¸€ä¸ªå®éªŒçœ‹ä¸€ä¸‹æ•ˆæœå¦‚ä½•ï¼Œå®éªŒè®¾ç½®å¦‚ä¸‹ï¼š

> - `target model`
> opt-66b (AutoTP è·‘åœ¨ 8 å¼  A100)
> - `draft model`
> opt-125m (å•å¼  A100 æˆ– å•è·¯ SPR CPU)
> - IO
> 
>  input tokens: 32
> 
>  new_tokens: 32
> 
>  data type: bf16
> - å…¶ä»–è®¾ç½®
> Kï¼šåŠ¨æ€å–å€¼ã€‚åˆå§‹å€¼ä¸º1ï¼Œå¦‚æ‰€æœ‰çš„ `target model` æ¥å—äº† `draft model` æ‰€æœ‰çš„è‰ç¨¿ï¼Œåˆ™ K åŠ  1ï¼›å¦åˆ™ï¼ŒK å‡ 1ã€‚

ç»“æœå¦‚ä¸‹ï¼š

![Alt text](assets/assisted-decoding-new-paradigm/image-3.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ `Hugging Face transformers` ä¸‹ `opt-66b` çš„æ¯è¯å…ƒå»¶è¿Ÿæ˜¯ `43ms`ï¼Œä½¿ç”¨äº† `opt-125m` ä½œä¸º `draft model` å¹¶é‡‡ç”¨è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆæ¶æ„åï¼ŒåŠ é€Ÿæ¯”è¾¾ `1.37`ã€‚ç”šè‡³å¯ä»¥åšå¼‚æ„è¾…åŠ©å¼æ–‡æœ¬ç”Ÿæˆï¼Œå°†  `opt-125m` æ”¾åˆ°æœºå¤´çš„ CPU ä¸Šè¿è¡Œï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼ŒåŠ é€Ÿæ¯”è¾¾ `1.5`ï¼Œè¿˜å®ç°äº†æ•´æœºç¡¬ä»¶çš„å……åˆ†åˆ©ç”¨ã€‚
åœ¨å°è¯• `vanilla` æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜å‘ç°äº†ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼š

- ä¸åŒæ¨¡å‹åœ¨ç›¸åŒçš„ `K`  ä¸‹çš„ `compression ratio` æœ‰è¾ƒå¤§çš„å·®å¼‚ã€‚ä¸‹å›¾æ˜¯ `bloom-560m + bloom-176b` çš„ `compression ratio`ï¼Œå¯ä»¥çœ‹åˆ°å…¶æ¯”ä¸Šå›¾çš„ `opt-125m + opt-66b` ä½ä¸å°‘ã€‚æˆ‘ä»¬çš„ç›´è§‰æ˜¯è§‰å¾—è¿™æ˜¯ç”±äº `bloom` ç³»åˆ—æ¨¡å‹æ¯” `opt` ç³»åˆ—æ¨¡å‹è¯è¡¨å¤§å¾ˆå¤šçš„ç¼˜æ•…ï¼ˆ`bloom`  ä¸º `250880` vs `opt`  ä¸º `50272`ï¼‰ã€‚

    ![Alt text|center](assets/assisted-decoding-new-paradigm/image-4.png)

-  dynamic `K` æ¯”è¾ƒæœ‰ç”¨ï¼Œå…å»è®¾è¶…å‚çš„çƒ¦æ¼ï¼Œæ‹¯æ•‘å¤´çš®ï¼ä¸‹å›¾ç»™å‡ºäº† `bloom-560m + bloom-176b` åœ¨å›ºå®š `K` å’Œ dynamic `K` ä¸‹çš„ `compression ratio` è¡¨ç°ï¼Œå¯ä»¥çœ‹å‡ºæ•ˆæœåŸºæœ¬ä¸ `K=2` ç›¸å½“ã€‚

    ![Alt text|center](assets/assisted-decoding-new-paradigm/image-5.png)

- è½¯åŒ¹é…å¯¹æé«˜æ¥å—ç‡æœ‰æ˜æ˜¾çš„æ•ˆæœã€‚å¯¹äºä½¿ç”¨ `top-K` æˆ–è€… `top-P` è¿™ç±»å¸¦æœ‰éšæœºæ€§çš„ç”Ÿæˆç­–ç•¥çš„åœºæ™¯è€Œè¨€ï¼Œå¯ä»¥ä¸ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œè€Œä½¿ç”¨è½¯åŒ¹é…ã€‚

> **è½¯åŒ¹é…ç­–ç•¥**
> å¯¹ `draft model` ç”Ÿæˆçš„æ¯ä¸ªè¯å…ƒï¼Œæ¯”è¾ƒ `draft model` è®¡ç®—çš„ logit `q` ä»¥åŠ `target model` è®¡ç®—çš„ logit `p`:
> è‹¥ `q < p`ï¼Œåˆ™æ¥å—è¯¥è¯å…ƒ
> å¦åˆ™ï¼š
> - è‹¥ $1 - \frac{p}{q} > \beta$ï¼Œåˆ™æ¥å—è¯¥è¯å…ƒ
> - å¦åˆ™ï¼Œæ‹’ç»è¯¥è¯å…ƒ

çœ‹ä¸‹è½¯åŒ¹é…ç­–ç•¥çš„æ•ˆæœï¼Œä»¥ `bloom-560m + bloom-176b` å’Œ `bloom-1b7 + bloom-176b` ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼Œå¯è§å…¶æ˜¾è‘—æé«˜äº†æ¥å—ç‡ã€‚

![Alt text|center](assets/assisted-decoding-new-paradigm/image-6.png)

### è‡ªæŠ•æœºè§£ç 
èµ·åˆï¼Œåœ¨é€‰æ‹© `draft model` æ—¶ï¼Œä¸€èˆ¬é€‰æ‹©åŒå®¶æ—ä¸­çš„å°å°ºå¯¸æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹æ˜¯åŸºäºåŒä¸€ä¸ªè®­ç»ƒé›†è®­ç»ƒå‡ºæ¥çš„ï¼Œä¸”å…±äº«åŒä¸€ä¸ªè¯è¡¨ï¼Œå› æ­¤ä¸éš¾å‡è®¾å…¶ä¸ `target model` çš„å¯¹é½æ€§è¾ƒå¥½ã€‚è‡ªæŠ•æœºæ–¹æ³•çš„æƒ³æ³•å°±æ˜¯ä¸ºä½•ä¸ç›´æ¥åœ¨ `target model` ä¸­é€‰ä¸€äº›å±‚ç»„æˆå°æ¨¡å‹å‘¢ï¼Œåæ­£ LLM ä¹Ÿå°±æ˜¯ä¸€ç»„åŒè§„æ ¼çš„ transformer block çš„å †å ï¼Œè·³è¿‡ä¸€äº›å±‚å¹¶ä¸ä¼šå¯¼è‡´æ•°æ®å°ºå¯¸ä¸å…¼å®¹ã€‚ç”±æ­¤ï¼Œä½œè€…ä½¿ç”¨äº†è´å¶æ–¯ä¼˜åŒ–æ–¹æ³•å¯¹æ¯ä¸ªæ³¨æ„åŠ›å±‚å’Œ MLP å±‚é€‰æ‹©è·³è¿‡æˆ–ä¸è·³è¿‡ï¼Œä»¥æœ€ç»ˆå†³å®šæŠ½å–å“ªäº›å±‚ç»„æˆ `draft model`ã€‚è¿™ä¸€æ•´å¥—è·¯æ•°å¤ç”¨çš„æ˜¯ä¹‹å‰ `NAS` çš„å¥—è·¯ï¼Œä»¥åœ¨ $l_d$ å’Œæ¥å—ç‡ä¹‹é—´æ±‚å¾—æœ€ä¼˜è§£ã€‚

![Alt text|center](assets/assisted-decoding-new-paradigm/image-7.png)

ä»¥ä¸Šæ˜¯äº‹å®ï¼Œä»¥ä¸‹æ˜¯è§‚ç‚¹ã€‚

è¿™ä¸€å¥—è™½ç„¶å¾ˆå¥½çœ‹ï¼Œä½†å¦‚æœä»å·¥ç¨‹çš„è§’åº¦çœ‹ï¼Œä¸ªäººå¹¶ä¸ååˆ†æ„Ÿå†’ã€‚è´å¶æ–¯è¿™ä¸€é¡¿è£æ˜¯åŸºäºæŸä¸ªæ ¡å‡†æ•°æ®é›†çš„ï¼Œå› æ­¤è£å‰ªå‡ºçš„æ¨¡å‹ä¸ç®¡æ˜¯æ€§èƒ½ï¼ˆå¦‚æç¤ºé•¿åº¦ã€ç”Ÿæˆé•¿åº¦ç­‰ï¼‰è¿˜æ˜¯ç”Ÿæˆè´¨é‡å…¶å®éƒ½æ˜¯åŸºäºè¿™ä¸ªæ•°æ®é›†çš„æœ€ä¼˜ï¼Œæ³›åŒ–æ€§å§‹ç»ˆéƒ½æ˜¯æ‰“é—®å·çš„ã€‚æ‹›å­æ¯”è¾ƒèŠ±ï¼Œä½†æ˜¯å®ç”¨æ€§æœ‰é™ã€‚è‡ªæŠ•æœºçš„æ–¹å‘ï¼Œä¸ªäººè¿˜æ˜¯è§‰å¾—å¦‚æœèƒ½ä¸è·³å±‚ï¼Œé€‰å‰ N å±‚ä½œä¸º `draft model` æ˜¯æœ€å¥½çš„ï¼Œè¿™æ ·ï¼š
1) å¯è½»æ˜“åœ°å®ç°ç«¯äº‘ååŒï¼Œæ—¢æ‹†åˆ†ï¼Œåˆèƒ½è”åˆåœ¨çº¿å­¦ä¹ ã€‚
2) å‰ N å±‚çš„ KV-cache å¯å¤ç”¨ï¼Œè¿›ä¸€æ­¥åŠ é€Ÿ `target model`ã€‚
3) åœ¨ç«¯äº‘åœºæ™¯ï¼ŒåŸç”Ÿæ”¯æŒéšç§è®¡ç®—ï¼Œå¯ä¸å°†ç”¨æˆ·æ•°æ®ä¼ ç»™äº‘ç«¯ï¼Œåªä¼  N å±‚çš„è¾“å‡ºç»™äº‘ç«¯ã€‚

ä»¥ä¸Šä»…ä¸ºä¸ªäººè§‚ç‚¹ã€‚

### SpecInfer

åŸºæœ¬æ¶æ„å·²ç»æ­æˆï¼Œä¸‹é¢å°±æ˜¯å¦‚ä½•è¿›ä¸€æ­¥åŠ é€Ÿäº†ã€‚ä»ä¸Šæ–‡çš„ä¼°ç®—å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œä»ç®—æ³•ä¸Šæ¥çœ‹ï¼Œæé€Ÿçš„å…³é”®åœ¨äºæé«˜æ¥å—ç‡ $\alpha$ã€‚é‚£ä¹ˆå¦‚ä½•æé«˜æ¥å—ç‡å‘¢ï¼Ÿå…³é”®åœ¨äºå®¡å®šæœºåˆ¶ï¼Œä¸Šè¿°æ–¹æ³•çš„åšæ³•æ˜¯ï¼š`draft model` åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½åªèµ·è‰ä¸€ä¸ªè¯å…ƒä¾› `target model` å®¡å®šã€‚è¿™ç§æ–¹æ³•å¯¹ `draft model` å’Œ `target model` çš„ `top-1` å¯¹é½èƒ½åŠ›æœ‰å¾ˆé«˜çš„è¦æ±‚ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ—¦å½“å‰æ—¶é—´æ­¥ `top-1` ä¸å¯¹é½ï¼Œåé¢æ‰€æœ‰çš„é¢„æµ‹éƒ½ä½œåºŸäº†ï¼Œå› æ­¤æå¤§é™åˆ¶äº†æ¥å—ç‡çš„æé«˜ã€‚è€Œè§£è„±ä¹‹é“å°±åœ¨å…¶ä¸­ï¼æˆ‘ä»¬çŸ¥é“ï¼š

1ï¼‰å¤§å°æ¨¡å‹çš„ `top-1` å¯¹é½è‚¯å®šæ˜¯ä¸èƒ½æŒ‡æœ›å¤ªå¤šçš„ï¼Œå¦åˆ™å°æ¨¡å‹çš„èƒ½åŠ›å…¶å®å°±è·Ÿå¤§çš„å·®ä¸å¤šäº†ï¼Œä¸éœ€è¦å¤§çš„äº†ï¼›

2ï¼‰ä½†æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œè¿™ä¿©èƒ½åŠ›ç›¸å·®ä¹Ÿä¸ä¼šå¤ªå¤§ï¼Œå¤§æ¨¡å‹çš„è¾“å‡ºåœ¨å°æ¨¡å‹çš„ `top-k` ä¸­çš„æ¦‚ç‡è‚¯å®šä¸ä¼šä½ã€‚è‡³æ­¤ï¼ŒSpecInfer å°±åº”è¿è€Œå‡ºäº†ï¼

![Alt text|center](assets/assisted-decoding-new-paradigm/image-8.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSpecInfer é‡‡ç”¨ beam search çš„æ–¹æ³•ï¼ˆexpansion basedï¼‰æˆ– ensemble æ–¹æ³•ï¼ˆmerge basedï¼‰ ç”Ÿæˆè‰ç¨¿ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºæ¯ä¸ªæ—¶é—´æ­¥ç”Ÿæˆå¤šä¸ªå€™é€‰è¯ï¼Œä»¥æé«˜æ¥å—ç‡ã€‚ä»–è¿˜åšäº†ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯æŠŠç”Ÿæˆçš„å¤šä»½è‰ç¨¿æ•´ç†æˆä¸€æ£µæ ‘çš„å½¢å¼ï¼Œä»¥å……åˆ†åˆ©ç”¨å®ƒä»¬ä¹‹é—´é‡å çš„è¯ï¼Œå‡å°‘è®¡ç®—é‡ï¼ŒåŠ é€Ÿ $l_t$ã€‚æ€è·¯å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆåˆç†ã€‚

ä»¥ä¸‹æ˜¯ `opt-125m + opt-13b` åœ¨å›ºå®š `K=5` è®¾å®šä¸‹çš„å®éªŒç»“æœã€‚å¯ä»¥çœ‹åˆ°å¢åŠ  beam width åˆ° 8ï¼Œ `compression ratio` æœ‰æ˜æ˜¾æé«˜ï¼Œå† ensemble 5 ä¸ª æ¨¡å‹ï¼Œåˆæœ‰è¿›ä¸€æ­¥æé«˜ï¼ŒéªŒè¯äº†ä¸Šè¿°è¯´æ³•ã€‚ 

![Alt text|center](assets/assisted-decoding-new-paradigm/image-9.png)

æ€»ç»“ä¸€ä¸‹ï¼ŒSpecInfer çš„æ¶æ„å¦‚ä¸‹ï¼š

![Alt text|center](assets/assisted-decoding-new-paradigm/image-10.png)

### LADE

æ‰ªå¿ƒè‡ªé—®ä¸€ä¸‹ï¼š`draft model` å°±å¿…é¡»å°±æ˜¯ä¸ª LLM çš„å°å…„å¼Ÿå—ï¼Ÿå¥½åƒä¹Ÿä¸è§å¾—ï¼Œåªè¦èƒ½è¾“å‡ºæ¥å—ç‡è¾ƒé«˜ï¼Œç®¡å®ƒæ˜¯ä¸æ˜¯ä¸ªæœ‰å‚çš„ LMã€‚è¯è¯´åˆ°è¿™å„¿å°±å¼•å…¥äº† `LADEï¼ˆLook Ahead DEcodingï¼‰`ã€‚`LADE` åšå¾—æ¯”è¾ƒç»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®ƒç”¨äº†ä¸€ä¸ªæ— å‚çš„ã€åœ¨çº¿å­¦ä¹ çš„ `n-gram` LM ä½œä¸º `draft model`ã€‚

![Alt text|center](assets/assisted-decoding-new-paradigm/image-11.png)

å…¶æµç¨‹å¦‚ä¸‹ï¼š

> 1. ç”¨æç¤ºä¸­çš„æœ€åä¸€ä¸ªè¯å…ƒä¸ºé”®å»ä» n-gram æ¨¡å‹æ‰¾å®ƒçš„ `n-1` ä¸ªè¡¥å…¨è¯ã€‚æœ‰å¯èƒ½æ‰¾åˆ°å¤šä¸ªï¼Œæ­¤æ—¶æœ€å¤šç”¨  `G` ä¸ªï¼›ä¹Ÿæœ‰å¯èƒ½æ²¡æœ‰ï¼Œæ­¤æ—¶éšæœºè¡¥å…¨
> 2. LLM å®¡å®š
> 4. å°† LLM å®¡å®šé€šè¿‡çš„æ–° n-gram æ›´æ–°å…¥ n-gram æ¨¡å‹
> 5. å¦‚ç”Ÿæˆå®Œæˆï¼Œé€€å‡ºï¼›å¦åˆ™ï¼Œè¿”å›ç¬¬ 1 æ­¥

ä¸‹å›¾ä»¥ `2-gram` ä¸ºä¾‹å±•ç¤ºäº†è¯¥æµç¨‹ï¼š

![Alt text](assets/assisted-decoding-new-paradigm/image-12.gif)

æˆ‘ä»¬åšä¸ªç®€å•çš„å®éªŒï¼Œ`7-gram + TinyLlama-1.1B-Chat-v0.3`ï¼Œä¸” `K` è®¾ä¸º 20ï¼Œè¾“å…¥é•¿åº¦ä¸º 32ï¼Œ è¾“å‡ºé•¿åº¦ä¸º 256 æ—¶ï¼Œæ€§èƒ½å¦‚ä¸‹ï¼š

![Alt text|center](assets/assisted-decoding-new-paradigm/image-13.png)

å¯ä»¥çœ‹åˆ°åœ¨ A100 å•å¡ä¸‹ï¼Œæ€§èƒ½æœ‰ 1.58 å€çš„æå‡ã€‚

## æ€»ç»“

ä»¥ä¸Šä»‹ç»äº†è¾…åŠ©å¼æ–‡æœ¬ç”ŸæˆèŒƒå¼ï¼Œè¯¥èŒƒå¼ä¸ºâ€œå…è´¹â€é™ä½æ–‡æœ¬ç”Ÿæˆæ¯è¯å…ƒæˆæœ¬æä¾›äº†å¯èƒ½æ€§ã€‚åŒæ—¶è¿˜ä»‹ç»äº†è¯¥èŒƒå¼ä¸‹çš„å››ç§å…¸å‹ç®—æ³•ã€‚ä¸ªäººè®¤ä¸ºè¿™ä¸€èŒƒå¼æ˜¯æ·±å…·æ½œåŠ›çš„ï¼ŒåŸå› ä¹‹ä¸€æ­£å¦‚å¼€ç¯‡æ‰€è®²ï¼Œå…¶æä¾›äº†æ— æŸçš„é€æ˜åŠ é€ŸèŒƒå¼ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ä¸“æ³¨äºåº”ç”¨æœ¬èº«ï¼Œè€Œä¸æ˜¯èŠ±å¾ˆå¤šæ—¶é—´ã€é‡‘é’±å’Œèµ„æºç”¨äºå‹ç¼©æ¨¡å‹ï¼Œæƒè¡¡æ”¶ç›Šã€‚å…¶äºŒæ˜¯å…¶èŒƒå¼æ„å‹çš„çµæ´»æ€§ï¼Œå¯ä»¥é€‚åº”å¤šç§éƒ¨ç½²è®¾è®¡ï¼šå…¨éƒ¨éƒ¨ç½²åœ¨åŠ é€Ÿå™¨ä¸Šï¼Ÿå¯ä»¥! å¼‚æ„éƒ¨ç½²ï¼Œ`draft model` éƒ¨ç½²åœ¨ CPU ä¸Šï¼Œ `target model` éƒ¨ç½²åœ¨åŠ é€Ÿå™¨ä¸Šï¼Ÿ ä¹Ÿè¡Œï¼ç«¯äº‘ååŒï¼Œ`draft model` éƒ¨ç½²åœ¨ç«¯ä¾§ï¼Œ `target model` éƒ¨ç½²åœ¨äº‘ä¾§ï¼Ÿ æœªå°ä¸å¯ï¼æƒ³è±¡çš„ç”»å·æ­£åœ¨å±•å¼€......

## å‚è€ƒæ–‡çŒ®

1. [Fast Inference from Transformers via Speculative Decoding](https://arxiv.org/pdf/2211.17192)
2. [Draft & Verify: Lossless Large Language Model Acceleration via Self-Speculative Decoding](https://arxiv.org/pdf/2309.08168.pdf)
3. [SpecInfer: Accelerating Generative Large Language Model Serving with Tree-based Speculative Inference and Verification](https://arxiv.org/pdf/2305.09781.pdf)
4. [Break the Sequential Dependency of LLM Inference Using Lookahead Decoding](https://lmsys.org/blog/2023-11-21-lookahead-decoding/)
 